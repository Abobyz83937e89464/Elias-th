<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elians Chat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #00f3ff; --pink: #bc13fe; --bg: #050716; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        .screen { display: none; flex-direction: column; align-items: center; padding: 20px; height: 100%; width: 100%; box-sizing: border-box; }
        .active { display: flex; }

        .btn {
            background: linear-gradient(135deg, var(--neon), var(--pink));
            border: none; border-radius: 20px; padding: 15px; color: white; font-weight: bold; width: 90%; margin: 10px 0;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        input { background: rgba(255,255,255,0.1); border: 1px solid var(--neon); padding: 15px; border-radius: 15px; color: white; width: 80%; text-align: center; font-size: 1.1rem; margin: 10px 0; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .top-bar { width: 100%; padding: 10px; background: rgba(0,0,0,0.5); position: relative; }
        .timer-line { height: 5px; background: var(--pink); width: 100%; position: absolute; top: 0; left: 0; transition: width 1s linear; }
        .score-board { display: flex; justify-content: space-around; font-size: 1.2rem; font-weight: bold; }
        
        .word-card { 
            background: linear-gradient(45deg, #1a1a2e, #16213e); 
            border: 2px solid var(--neon); padding: 20px; border-radius: 15px; margin: 10px; width: 85%;
            font-size: 2rem; font-weight: bold; text-shadow: 0 0 10px var(--neon);
            box-shadow: 0 0 20px rgba(0,243,255,0.2);
        }

        /* –ß–∞—Ç */
        #chatBox {
            flex: 1; width: 100%; overflow-y: auto; padding: 10px; text-align: left;
            background: rgba(0,0,0,0.2); border-top: 1px solid #333; margin-bottom: 60px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∏–Ω–ø—É—Ç */
        }
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,0.05); font-size: 0.95rem; }
        .msg b { color: var(--neon); }
        .sys-msg { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; text-align: center; }

        .input-area {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px; background: #111;
            display: flex; gap: 10px; box-sizing: border-box;
        }
        .chat-input { flex: 1; margin: 0; text-align: left; }
        .send-btn { width: 50px; background: var(--neon); border: none; border-radius: 10px; color: black; font-weight: bold; margin: 0; }
    </style>
</head>
<body>

<div id="menu" class="screen active">
    <h1 style="font-size: 3rem; text-shadow: 0 0 20px var(--pink);">ELIANS</h1>
    <button class="btn" onclick="ws.send(JSON.stringify({type:'CREATE_ROOM'}))">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
    <input id="joinCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
    <button class="btn" style="background: transparent; border: 1px solid var(--neon);" onclick="join()">–í–û–ô–¢–ò</button>
</div>

<div id="lobby" class="screen">
    <h2>–ö–û–î: <span id="lobbyCode" style="color:var(--neon)">---</span></h2>
    <div id="lobbyList">–ñ–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...</div>
    <button id="startBtn" class="btn" style="display:none; background:#2ecc71; margin-top:20px;" onclick="ws.send(JSON.stringify({type:'START_GAME'}))">–ù–ê–ß–ê–¢–¨</button>
    <button class="btn" style="background:transparent; border:1px solid #555" onclick="invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨</button>
</div>

<div id="game" class="screen" style="padding: 0;">
    <div class="top-bar">
        <div class="timer-line" id="timerBar"></div>
        <div class="score-board">
            <span style="color:var(--neon)">A: <span id="scoreA">0</span></span>
            <span style="color:var(--pink)">B: <span id="scoreB">0</span></span>
        </div>
    </div>

    <div id="explainerZone" style="display:none; width: 100%; display: flex; justify-content: center;">
        <div class="word-card" id="wordTarget">–°–õ–û–í–û</div>
    </div>
    
    <div id="statusZone" style="padding: 10px; opacity: 0.8;"></div>

    <div id="chatBox"></div>

    <div class="input-area" id="inputArea" style="display:none;">
        <input id="msgInput" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const ws = new WebSocket(`${location.protocol==='https:'?'wss:':'ws:'}//${location.host}`);
    let myRoom = "";

    ws.onopen = () => ws.send(JSON.stringify({ type: "REGISTER", userId: tg.initDataUnsafe.user?.id, username: tg.initDataUnsafe.user?.first_name || "Guest" }));

    ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        
        if(d.type === "ROOM_CREATED" || d.type === "JOIN_SUCCESS") {
            myRoom = d.roomId;
            document.getElementById('lobbyCode').innerText = d.roomId;
            showScreen('lobby');
        }

        if(d.type === "LOBBY_UPDATE") {
            document.getElementById('lobbyList').innerHTML = d.players.map(p => `<div>üë§ ${p}</div>`).join("");
            if(d.count >= 2) document.getElementById('startBtn').style.display = "block";
        }

        if(d.type === "ROUND_START") {
            showScreen('game');
            document.getElementById('chatBox').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
            startTimer(d.time);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –ø–æ —Ä–æ–ª—è–º
            const expZone = document.getElementById('explainerZone');
            const statZone = document.getElementById('statusZone');
            const inpArea = document.getElementById('inputArea');
            const inp = document.getElementById('msgInput');

            expZone.style.display = 'none';
            inpArea.style.display = 'none';
            
            if(d.role === 'explainer') {
                expZone.style.display = 'flex';
                document.getElementById('wordTarget').innerText = d.word;
                statZone.innerText = "–û–±—ä—è—Å–Ω—è–π —Å–ª–æ–≤–æ –∫–æ–º–∞–Ω–¥–µ!";
                inpArea.style.display = 'flex';
                inp.placeholder = "–ü–∏—à–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É...";
            } else if(d.role === 'guesser') {
                statZone.innerText = `–£–≥–∞–¥—ã–≤–∞–π! –û–±—ä—è—Å–Ω—è–µ—Ç: ${d.explainerName}`;
                inpArea.style.display = 'flex';
                inp.placeholder = "–ü–∏—à–∏ –æ—Ç–≤–µ—Ç —Å—é–¥–∞...";
            } else {
                statZone.innerText = `–°–º–æ—Ç—Ä–∏! –•–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞. –û–±—ä—è—Å–Ω—è–µ—Ç: ${d.explainerName}`;
                // –ó—Ä–∏—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —á–∞—Ç, –Ω–æ –ø–∏—Å–∞—Ç—å –Ω–µ –º–æ–≥—É—Ç (–º–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å, –µ—Å–ª–∏ —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç if)
            }
        }

        if(d.type === "CHAT_NEW") {
            const box = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = d.isSystem ? 'msg sys-msg' : 'msg';
            msgDiv.innerHTML = d.isSystem ? d.text : `<b>${d.from}:</b> ${d.text}`;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight; // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
        }

        if(d.type === "NEW_WORD") {
            // –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã —Å–ª–æ–≤–∞
            const card = document.getElementById('wordTarget');
            card.style.transform = "scale(0.8)";
            setTimeout(() => {
                card.innerText = d.word;
                card.style.transform = "scale(1)";
            }, 200);
        }

        if(d.type === "SCORE_UPDATE") {
            document.getElementById('scoreA').innerText = d.scores.A;
            document.getElementById('scoreB').innerText = d.scores.B;
        }
        
        if(d.type === "ERROR") tg.showAlert(d.text);
    };

    function sendMsg() {
        const inp = document.getElementById('msgInput');
        const txt = inp.value.trim();
        if(txt) {
            ws.send(JSON.stringify({ type: "CHAT_MESSAGE", text: txt }));
            inp.value = '';
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
    document.getElementById('msgInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMsg();
    });

    function startTimer(sec) {
        const bar = document.getElementById('timerBar');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        setTimeout(() => {
            bar.style.transition = `width ${sec}s linear`;
            bar.style.width = '0%';
        }, 100);
    }

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function join() { const c = document.getElementById('joinCode').value; if(c) ws.send(JSON.stringify({type:"JOIN_ROOM", roomId: c})); }
    function invite() { tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent("–ò–≥—Ä–∞–µ–º –≤ Alias! –ö–æ–¥: " + myRoom)}`); }
</script>
</body>
</html>
